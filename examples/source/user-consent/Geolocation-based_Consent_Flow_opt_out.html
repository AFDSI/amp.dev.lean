<!---

teaserImage: '/static/samples/img/teaser/geolocation-based_consent_flow.jpg'
author: sebastianbenz

--->

<!--
  ## Introduction

  Sometimes is necessary to ask only users from specific countries for consent. This sample demonstrates
  how you can use `amp-consent` together with `amp-geo` to achieve this. In this sample we'll build a
  consent dialog that will only show for users from US.
-->
<!-- -->
<!doctype html>
<html âš¡>
<head>
  <meta charset="utf-8">
  <link rel="canonical" href="<% canonical %>">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
  <script async src="https://cdn.ampproject.org/v0.js"></script>
  <title>Geolocation-based Opt Out Consent Flow</title>
  <!-- ## Setup -->
  <!--
  We need to import both, the `amp-consent` ...
  -->
  <script async custom-element="amp-consent" src="https://cdn.ampproject.org/v0/amp-consent-0.1.js"></script>
  <!--
  ... and the `amp-geo` extension.
  -->
  <script async custom-element="amp-geo" src="https://cdn.ampproject.org/v0/amp-geo-0.1.js"></script>
  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
  <style amp-custom>
    :root {
      --space-2: 1rem;   /* 16px */
      --space-3: 1.5rem; /* 24px */
    }
    .consentPopup {
      padding: var(--space-3);
      margin: 0 auto;
      background: #fff;
      border-radius: 5px;
      position: relative;
      max-width: 700px;
      width: 95%;
    }
    .consentPopup > h2, /* overwrite ABE style */
    .consentPopup > * {
      margin: 0;
      margin-bottom: var(--space-2);
    }
    .consentPopup > button {
      margin-right: var(--space-2);
    }
    .popupOverlay {
      height: 100vh;
      width: 100vw;
      background: rgba(0, 0, 0, 0.7);
      padding: 5% 0;
    }
    .dismiss-button {
      position: absolute;
      right: var(--space-3);
      top: var(--space-2);
      cursor: pointer;
    }
    #post-consent-ui {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--space-3);
    }
  </style>
</head>
<body>
  <!-- ## Setting up amp-geo -->
  <!-- First we need to setup the [`amp-geo`](/content/amp-dev/documentation/components/reference/amp-geo-v0.1.md) extension. We'll use the iso code `us` which represents the United States. -->
  <amp-geo layout="nodisplay">
    <script type="application/json">
      {
        "ISOCountryGroups": {
          "eu": [ "preset-eea" ],
          "us": [ "us" ]
        }
      }
    </script>
  </amp-geo>

  
  <!-- ## Defining the consent flow -->
  <!--
    The flow should only trigger for users in the US, and we would like our servers to determine if consent is required for this user and if we have an existing consent value for them, so we set the flag: `geoOverride`.

    You can learn more about the geoOverride flag [here](https://github.com/ampproject/amphtml/tree/master/extensions/amp-consent/amp-consent.md#geoOverride).

    If amp-geo finds that the user is in the US country group, then the contents of the US config will override the top-level consent config.

    Our final config for a US user would look like this: 
    ```json
    {
      "consentInstanceId": "world-wide-consent",
      "consentRequired": "remote",
      "checkConsentHref": "/documentation/examples/api/get-consent-geo-override",
      "promptUI": null,
      "postPromptUI": "post-consent-ui"
    }
    ```

    When a user lands on the AMP page, amp-consent will check local storage for an existing consent state. 
    If a consent state exists, it will unblock all components. Otherwise, it will wait for the responsef from `checkConsentHref` to determine if consent is required for this user and if there is an existing consent state. If there is an existing consent state, amp-consent will use that value and unblock. Otherwise, it will show the promptUi (if configured).

    Use `expireCache: true`, in your response to never save consent states to local storage and thus always prompt servers for consent state.

    A recommended design for sites that can manage their own consent (via external page) is to always respond with: 
    ```json
    {
        "expireCache": true,
        "consentRequired": true,
        "consentStateValue": "accepted"/"rejected"/"unknown",
        "consentString": "abc123"
    }
    ```

    Note: [`onUpdateHref`](https://github.com/ampproject/amphtml/tree/master/extensions/amp-consent/amp-consent.md#onUpdateHref) is mostly helpful when users are managing their consent directly on the page (not on an external page).
  -->
  <amp-consent id="myUserConsent" layout="nodisplay">
      <script type="application/json">{
        "consentInstanceId": "world-wide-consent",
        "consentRequired": false,
        "promptUI": "my-consent-ui",
        "geoOverride": {
          "eea": {
            "consentRequired": true
          },
          "us": {
            "consentRequired": "remote",
            "checkConsentHref": "/documentation/examples/api/get-consent-geo-override",
            "promptUi": null,
            "postPromptUI": null
          }
        },
        "postPromptUI": "post-consent-ui"
      }</script>
      <div id="my-consent-ui" class="popupOverlay">
        <div class="consentPopup">
          <div class="dismiss-button" role="button" tabindex="0" on="tap:myUserConsent.dismiss">X</div>
          <h2>Headline</h2>
          <p>This is an important message requiring you to make a choice if you're based in the US.</p>
          <button on="tap:myUserConsent.accept">Accept</button>
          <button on="tap:myUserConsent.reject">Reject</button>
        </div>
      </div>
      <div id="post-consent-ui">
        <button on="tap:myUserConsent.prompt()">Update Consent</button>
      </div>
    </amp-consent>

  <!-- ## Testing -->
  <!--
  You can test different behaviors by appending custom country codes to the URL and enabling the `dev-channel` [here](https://cdn.ampproject.org/experiments.html), for example:

  - US: [https://amp.dev/documentation/examples/user-consent/geolocation-based_consent_flow/#amp-geo=us](/content/amp-dev/documentation/examples/documentation/Geolocation-based_Consent_Flow.html#amp-geo=de)
  - non-US: [https://amp.dev/documentation/examples/user-consent/geolocation-based_consent_flow/#amp-geo=de](/content/amp-dev/documentation/examples/documentation/Geolocation-based_Consent_Flow.html#amp-geo=us)
  -->

</body>
</html>
