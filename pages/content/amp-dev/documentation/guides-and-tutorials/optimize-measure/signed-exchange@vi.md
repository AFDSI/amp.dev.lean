---
"$title": Phục vụ AMP bằng trao đổi nội dung đã kí danh
"$order": '4'
formats:
- websites
author: CrystalOnScript
---

AMP mang đến những lợi ích về tốc độ vượt xa phần định dạng thông qua những kĩ thuật như lưu bộ nhớ đệm và tải trước. Những lợi ích này có thể có [những mặt trái](https://blog.amp.dev/2017/02/06/whats-in-an-amp-url/) như có thêm nhiều URL được hiển thị khi được nhúng bên trong một [Trình xem AMP](https://developers.google.com/search/docs/guides/about-amp). Bằng cách phân phát nội dung AMP bằng trao đổi nội dung đã kí danh, bạn có thể dùng tính năng mới trong nền tảng web để vượt qua tất cả những mặt trái này.

Một [trao đổi nội dung đã kí danh](https://developers.google.com/web/updates/2018/11/signed-exchanges) bao gồm một tài liệu AMP hợp lệ và URL gốc của nội dung. Thông tin này được bảo vệ bởi những chữ kí kỹ thuật số, vốn liên kết bảo mật tài liệu này với URL của nó. Điều này giúp các trình duyệt hiển thị an toàn URL gốc trong thanh URL thay vì tên máy chủ phân phối các byte đến trình duyệt.

Nội dung AMP đã kí danh được chuyển phát *thêm vào* (chứ không thay thế) nội dung AMP thông thường.

{{ image('/static/img/docs/guides/sxg/sxg.png', 411, 293, layout='responsive', alt='Image displaying URL from signed exchange', caption=' ', align='' ) }}

[tip type="note"] This feature is currently supported on Chrome, but implementation is planned for additional browsers. [/tip]

# Will signed exchanges work for me?

To implement signed exchanges, you must meet the following requirements:

- Ability to configure and control the HTTP headers generated by your server. (Most purely web-based hosting solutions such as Blogger are *not* compatible with signed exchanges.)
- The ability to generate AMP signed exchanges, such as by running [`amppackager`](https://github.com/ampproject/amppackager/blob/master/README.md), as a [Go binary](https://golang.org/doc/install), or within a [Docker VM](https://docs.docker.com/machine/get-started/).
    - The packager needs to be updated every six weeks.
- The ability to [Vary](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary) on `Accept` and `AMP-Cache-Transform` headers on edge HTTP servers, returning different content for the same URL.
- The system running the `amppackager` needs to be able to make outgoing network requests to:
    - The certificate authority that issues your certificate
    - The publisher server that hosts the AMP documents to sign
    - `cdn.ampproject.org` to obtain the current version of AMP
- A persistent shared storage filesystem between all instances of `amppackager` running in the same data center.

# Implementing signed exchanges

Below is the suggested order of implementation to support signed exchanges on your AMP documents.

## Acquire a supported TLS certificate

To produce signed exchanges, you need a TLS certificate with the `CanSignHttpExchanges` extension. As of April 2019, [DigiCert](https://www.digicert.com/) is the only provider of this extension ([more info](https://docs.digicert.com/manage-certificates/certificate-profile-options/get-your-signed-http-exchange-certificate/)).

In order to generate the certificate, the Certificate Authority (CA) will require a Certificate Signing Request (CSR), which can be generated by `openssl`. An example CSR for `ampbyexample.com`:

```sh
# generate private key (if necessary)

$ openssl ecparam -out ampbyexample-packager.key -name prime256v1 -genkey
# generate CSR (the file ampbyexample-packager.csr)

$ openssl req -new -key ampbyexample-packager.key -nodes -out ampbyexample-packager.csr -subj "/C=US/ST=California/L=Mountain View/O=Google LLC/CN=ampbyexample.com"
```

## Determine which URLs will be signed

You will need to create a URL pattern that defines which documents should be signed. It is critical that private content, such as personalized information should not be signed, to avoid sending misleading or incorrect content.

For performance purposes, the packager should only be passed valid AMP documents as input. Some invalid AMP documents are fine if needed, but you should avoid sending all traffic through the packager.

## Deploy packager to a staging server

You should first set up signed exchanges on a staging server to verify your setup is correct before migrating to production.

Chúng tôi khuyến nghị dùng [`amppackager`](https://github.com/ampproject/amppackager/blob/master/README.md) để tạo trao đổi nội dung đã kí danh. Tuy nhiên nếu điều này không hợp cho môi trường sản xuất của bạn, bạn thay vào đó có thể dùng máy khách dòng lệnh [`transform`](https://github.com/ampproject/amppackager/blob/master/transformer/README.md) và [`gen-signedexchange`](https://github.com/WICG/webpackage/tree/master/go/signedexchange), và tự mình xử lí việc thoả thuận nội dung và các tác vụ quản lí chứng chỉ.

The following instructions apply to the deployments using `amppackager`.

### Cấu hình

Tập tin cấu hình (`amppkg.toml`) của [`amppackager`](https://github.com/ampproject/amppackager) yêu cầu **CertFile** và **KeyFile**.

**KeyFile** là khoá riêng tư (`ampbyexample-packager.key` trong ví dụ ở trên), và nó cần phải có định dạng sau. (Lưu ý: đừng chia sẻ khoá riêng tư của bạn, và chú ý không để lộ nó do sơ suất!)

```txt
-----BEGIN EC PARAMETERS-----
BggqhkjOPQMBBw==
-----END EC PARAMETERS-----
-----BEGIN EC PRIVATE KEY-----
MHcCAQEEINDgf1gprbdD6hM1ttmRC9+tOqJ+lNRtHwZahJIXfLADoAoGCCqGSM49
…
4j1NY29jVmAMQYrBYb+6heiv6ok+8c/zJQ==
-----END EC PRIVATE KEY-----
```

**CertFile** là chứng chỉ công khai. Nếu DigiCert cung cấp chứng chỉ này, tập tin này có thể được tạo bằng cách ghép lại với nhau chứng chỉ chuyên cho nguồn gốc do DigiCert cung cấp và tập tin `DigiCertCA.crt`.

```txt
-----BEGIN CERTIFICATE-----
MIIE0zCCBFmgAwIBAgIQCkEgeFknZluZtdcJnvdFCjAKBggqhkjOPQQDAjBMMQsw
CQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMSYwJAYDVQQDEx1EaWdp
Q2VydCBFQ0MgU2VjdXJlIFNlcnZlciBDQTAeFw0xODEwMzAwMDAwMDBaFw0xOTEx
MDYxMjAwMDBaMGIxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJjYTEWMBQGA1UEBxMN
TW91bnRhaW4gVmlldzETMBEGA1UEChMKR29vZ2xlIExMQzEZMBcGA1UEAxMQYW1w
YnlleGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABAGu0CjzWa6i
…
PXLGRK8i0lr7Jv6ZKPY8tfaB/c5yK404QU4HNggmAiEAlnNjIerjJOLHb8CvVaUQ
nhhn0a35nHp1yvE651W14fMwCgYIKoZIzj0EAwIDaAAwZQIwI4/7dpqJQxkQwpP3
DAjVOFdjC6PDcUIRPll3bF0srrTUXSyZ8xkM4q/RhB51A0hVAjEAsUGNYBje9RIO
wf9qyV2iHB+9cBwgKfC0KvEcBugbgHShypM8hPhV9UMC3qTpdKPx
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIDrDCCApSgAwIBAgIQCssoukZe5TkIdnRw883GEjANBgkqhkiG9w0BAQwFADBh
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBD
QTAeFw0xMzAzMDgxMjAwMDBaFw0yMzAzMDgxMjAwMDBaMEwxCzAJBgNVBAYTAlVT
…
loB5hWp2Jp2VDCADjT7ueihlZGak2YPqmXTNbk19HOuNssWvFhtOyPNV6og4ETQd
Ea8/B6hPatJ0ES8q/HO3X8IVQwVs1n3aAr0im0/T+Xc=
-----END CERTIFICATE-----
```

### Installation

Follow instructions [here to set up `amppackager` for your site](https://github.com/ampproject/amppackager/blob/master/README.md).

[tip type="read-on"] See [`packager.js`](https://github.com/ampproject/docs/blob/future/platform/lib/routers/packager.js) (used by `amp.dev`) for an example of the server-side changes you will need to make to route the required requests to `amppkg`. [/tip]

### Testing

Verify that your staging site responds with content of MIME type `application/signed-exchange` when specified by the HTTP request. For example (replace `staging.example.com` with your staging server):

```sh
$ curl -si -H 'amp-cache-transform: google;v="1..100"' -H 'accept: application/signed-exchange;v=b3;q=0.9,*/*;q=0.8' https://staging.example.com/ | less
```

The output must include this line:

```txt
content-type: application/signed-exchange;v=b3
```

[tip type="important"] The `v="1..100"` in the request is a placeholder. Do not match on this exact value; instead, as [described in the amppackager installation instructions](https://github.com/ampproject/amppackager/blob/master/README.md#productionizing), check for the existence of the `amp-cache-transform` header only, and ignore the value. [/tip]

[tip type="important"] The `v=b3` version string in the response is the version as of August 2019. This version will change. [/tip]

The bulk of the response should be your AMP page (in plaintext). There's a small binary header, and, if the page is >16kb, a few binary bytes sprinkled throughout.

The [`dump-signedexchange` tool](https://github.com/WICG/webpackage/blob/master/go/signedexchange/README.md#installation) can be used to inspect the response:

```sh
$ curl -s --output - -H 'amp-cache-transform: google;v="1..100"' -H 'accept: application/signed-exchange;v=b3;q=0.9,*/*;q=0.8' https://staging.example.com/ > example.sxg
$ dump-signedexchange -i example.sxg
format version: 1b3
```

(Note that the `-verify` switch will not work at this point because the required certificates are not on the `https://example.com/` server.)

Verify that the response *always* include the `Vary` header with the value `Accept,AMP-Cache-Transform` (irrespective of whether the MIME type is `text/html`, `application/signed-exchange`, or something else):

```sh
$ curl -si https://staging.example.com/ | less
```

This output must include this line:

```txt
vary: Accept,AMP-Cache-Transform
```

## Deploy packager to production

### Installation

Adjust the staging deployment steps above as appropriate for your production environment.

### Testing

#### With command-line tools

Run through the same tests as above. `dump-signedexchange -verify` should now also succeed.

#### With Chrome

Bạn còn có thể thừ nghiệm trong Chrome nhờ sự trợ giúp của [phần mở rộng ModHeader](https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj?hl=en). Cài đặt nó từ Chrome Webstore và cấu hình `Request Headers` thành `amp-cache-transform` với `Value` là `google`.

{{ image('/static/img/docs/guides/sxg/sxg1.jpg', 1900, 666, layout='responsive', alt='Testing Chrome with the help of the ModHeader extension', caption=' ', align='' ) }}

Sau khi yêu cầu `https://example.com/`, máy chủ của bạn sẽ phát một trao đổi nội dung đã kí danh, nhưng nó nên có diện mạo và cư xử y như trước. Bạn sẽ cần kiểm tra xem một trao đổi nội dung đã kí danh có được trả về chính xác qua [bảng điều khiển DevTools](https://developers.google.com/web/tools/chrome-devtools/) hay không.

{{ image('/static/img/docs/guides/sxg/sxg2.jpg', 3058, 1204, layout='responsive', alt='Signed exchange header displayed in the DevTools console', caption=' ', align='' ) }}

Under the `Network` tab, click on your domain name and check that `Signed HTTP exchange` appears under `Preview`.

#### With the Google AMP Cache

Confirm that the signed exchanges are compatible with the Google AMP cache. This related to their discoverability on search engines such as Google Search.

To test signed exchanges in the Google AMP cache, open the network tab in DevTools, enable `Preserve log`, and visit a URL such as `https://example-com.cdn.ampproject.org/wp/s/example.com/`.

DevTools will show a `200` with a `signed-exchange` row, and a `from signed-exchange` row, if the request was successful.

If unsuccessful, the signed-exchange rows will be missing, or they will be highlighted red. A `warning` header may also be present that provides additional information.

## Signed exchanges in Google Search

Nếu các trang AMP được phân phối thành công ở dạng trao đổi nội dung đã kí danh, những kết quả tìm kiếm của chúng sẽ hiển thị hình tia sét AMP, y như trước, nhưng khi chạm vào kết quả thì `https://example.com` sẽ hiện ở thanh URL, thay vì là một URL bắt đầu bằng `https://www.google.com/amp/….`. Ngoài ra, thanh `viewer` sẽ không xuất hiện.

Bên trong bảng điều khiển DevTools, bên dưới tab `network`, bạn sẽ thấy `signed-exchange` bên dưới cột `type`.

{{ image('/static/img/docs/guides/sxg/sxg3.jpg', 1366, 841, layout='responsive', alt='Within the DevTools console, under the network tab, you will be able to see signed-exchange under the type column.', caption=' ', align='' ) }}

# Signed exchange service providers

Here is a list of CDNs and hosting providers offering out-of-the-box support for signed exchanges. Using one of these is the easiest way to get started with signed exchanges:

- [AMP Packager Google Cloud Click-to-Deploy Installer](https://console.cloud.google.com/marketplace/details/google/amp-packager?filter=solution-type:k8s) [AMP Packager](https://github.com/ampproject/amppackager#amp-packager) là một công cụ để cải thiện URL của AMP bằng cách phục vụ AMP qua Tín hiệu được Ký nhận. Đọc thêm trên [AMP Blog](https://blog.amp.dev/2020/11/23/amp-packager-is-now-available-on-google-cloud-marketplace/).
- [Cloudflare AMP Real URL](https://www.cloudflare.com/website-optimization/amp-real-url/). [Cloudflare](https://www.cloudflare.com/) is one of the world’s largest networks. Today, businesses, non-profits, bloggers, and anyone with an Internet presence boast faster, more secure websites and apps thanks to Cloudflare.
