---
$title: Serve AMP using Signed Exchanges 
$order: 0
formats:
  - websites
author: CrystalOnScript
---

AMP provides speed benefits above and beyond the format through techniques like caching and preloading. These benefits can have [downsides](https://blog.amp.dev/2017/02/06/whats-in-an-amp-url/) like extra URLs being displayed when embeded inside an [AMP Viewer](https://developers.google.com/search/docs/guides/about-amp). By serving AMP content using Signed Exchanges, you can use a new web platform feature to overcome all of these.

A [Signed Exchange](https://developers.google.com/web/updates/2018/11/signed-exchanges) response is made up of a valid AMP document and the original URL of the content. This information is protected by digital signatures that securely tie the document to its claimed URL. This enables browsers to safely display the original URL in the URL bar instead of the hostname of the machine that delivered the bytes to the browser. 

Signed Exchange AMP content is delivered _in addition to_ (rather than instead of) regular AMP content.

{{ image('/static/img/docs/guides/sxg/sxg.png', 411, 293, layout='responsive', alt='Image displaying URLs after Signed Exchange', caption=' ', align='' ) }}

[tip type="note"]
    This feature is currently supported on Chrome, but implementation is planned for additional browsers. 
[/tip]

# Will Signed Exchanges work for me?

To implement Signed Exchanges, you must meet the following requirements:

*   Ability to configure and control the HTTP headers generated by your server. (Most purely web-based hosting solutions such as Blogger are _not_ compatible with Signed Exchanges.) 
*   The ability to generate AMP Signed Exchanges, such as by running [`amppackager`](https://github.com/ampproject/amppackager/blob/master/README.md), as a [Go binary](https://golang.org/doc/install), or within a [Docker VM](https://docs.docker.com/machine/get-started/). 
    *   The packager needs to be updated every six weeks.
*   The ability to [Vary](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary) on `Accept` and `AMP-Cache-Transform` headers on edge HTTP servers, returning different content for the same URL. 
*   The system running the `amppackager` needs to be able to make outgoing network requests to:
    *   The certificate authority that issues your certificate
    *   The publisher server that hosts the AMP documents to sign
    *   `cdn.ampproject.org` to obtain the current version of AMP
*   A persistent shared storage filesystem between all instances of `amppackager` running in the same data center. 

# Implementing Signed Exchanges 

Below is the suggested order of implementation to support Signed Exchanges on your AMP documents.

## Acquire a supported TLS certificate

To produce Signed Exchanges, you need a TLS certificate with the `CanSignHttpExchanges` extension. As of April 2019, [DigiCert](https://www.digicert.com/) is the only provider of this extension ([more info](https://docs.digicert.com/manage-certificates/certificate-profile-options/get-your-signed-http-exchange-certificate/)).

In order to generate the certificate, the Certificate Authority (CA) will require a Certificate Signing Request (CSR), which can be generated by `openssl`. An example CSR for `ampbyexample.com`:

```sh
# generate private key (if necessary)
$ openssl ecparam -out ampbyexample-packager.key -name prime256v1 -genkey
# generate CSR (the file ampbyexample-packager.csr)
$ openssl req -new -key ampbyexample-packager.key -nodes -out ampbyexample-packager.csr -subj "/C=US/ST=California/L=Mountain View/O=Google LLC/CN=ampbyexample.com"
```
## Determine which URLs will be signed 

You will need to create a URL pattern that defines which documents should be signed. It is critical that private content, such as personalized information should not be signed, to avoid sending misleading or incorrect content.

For performance purposes, the packager should only be passed valid AMP documents as input. Some invalid AMP documents are fine if needed, but you should avoid sending all traffic through the packager. 

## Deploy packager to a staging server

You should first set up Signed Exchanges on a staging server to verify your setup is correct before migrating to production.

We recommend using [`amppackager`](https://github.com/ampproject/amppackager/blob/master/README.md) to generate Signed Exchanges. However if this is not a good fit for your production environment you can instead use the command-line clients [`transform`](https://github.com/ampproject/amppackager/blob/master/transformer/README.md) and [`gen-signedexchange`](https://github.com/WICG/webpackage/tree/master/go/signedexchange), and handle the content negotiation and certificate management tasks yourself.

The following instructions apply to the deployments using `amppackager`.

### Configuration

[`amppackager`](https://github.com/ampproject/amppackager)'s config file (`amppkg.toml`) calls for a **CertFile** and a **KeyFile**.

The **KeyFile** is the private key (`ampbyexample-packager.key` in the example above), and it should have the following format. (Note: do not share your own private key, and protect it from inadvertent sharing!)

```txt
-----BEGIN EC PARAMETERS-----
BggqhkjOPQMBBw==
-----END EC PARAMETERS-----
-----BEGIN EC PRIVATE KEY-----
MHcCAQEEINDgf1gprbdD6hM1ttmRC9+tOqJ+lNRtHwZahJIXfLADoAoGCCqGSM49
…
4j1NY29jVmAMQYrBYb+6heiv6ok+8c/zJQ==
-----END EC PRIVATE KEY-----
```

The **CertFile** is the public certificate. If DigiCert provided the certificate, this can be created by concatenating together the origin-specific certificate provided by DigiCert and the `DigiCertCA.crt` file.


```txt
-----BEGIN CERTIFICATE-----
MIIE0zCCBFmgAwIBAgIQCkEgeFknZluZtdcJnvdFCjAKBggqhkjOPQQDAjBMMQsw
CQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMSYwJAYDVQQDEx1EaWdp
Q2VydCBFQ0MgU2VjdXJlIFNlcnZlciBDQTAeFw0xODEwMzAwMDAwMDBaFw0xOTEx
MDYxMjAwMDBaMGIxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJjYTEWMBQGA1UEBxMN
TW91bnRhaW4gVmlldzETMBEGA1UEChMKR29vZ2xlIExMQzEZMBcGA1UEAxMQYW1w
YnlleGFtcGxlLmNvbTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABAGu0CjzWa6i
…
PXLGRK8i0lr7Jv6ZKPY8tfaB/c5yK404QU4HNggmAiEAlnNjIerjJOLHb8CvVaUQ
nhhn0a35nHp1yvE651W14fMwCgYIKoZIzj0EAwIDaAAwZQIwI4/7dpqJQxkQwpP3
DAjVOFdjC6PDcUIRPll3bF0srrTUXSyZ8xkM4q/RhB51A0hVAjEAsUGNYBje9RIO
wf9qyV2iHB+9cBwgKfC0KvEcBugbgHShypM8hPhV9UMC3qTpdKPx
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIDrDCCApSgAwIBAgIQCssoukZe5TkIdnRw883GEjANBgkqhkiG9w0BAQwFADBh
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBD
QTAeFw0xMzAzMDgxMjAwMDBaFw0yMzAzMDgxMjAwMDBaMEwxCzAJBgNVBAYTAlVT
…
loB5hWp2Jp2VDCADjT7ueihlZGak2YPqmXTNbk19HOuNssWvFhtOyPNV6og4ETQd
Ea8/B6hPatJ0ES8q/HO3X8IVQwVs1n3aAr0im0/T+Xc=
-----END CERTIFICATE-----
```

### Installation

Follow instructions [here to set up `amppackager` for your site](https://github.com/ampproject/amppackager/blob/master/README.md).

[tip type="read-on"]
See [`packager.js`](https://github.com/ampproject/docs/blob/future/platform/lib/routers/packager.js) (used by `amp.dev`) for an example of the server-side changes you will need to make to route the required requests to `amppkg`.
[/tip]

### Testing

Verify that your staging site returns the content with the added MIME type `application/signed-exchange` when provided with the correct request headers. In the below example, replace `staging.example.com` with your staging server.

```sh
$ curl -si -H 'amp-cache-transform: google' -H 'accept: application/signed-exchange;v=b3;q=0.9,*/*;q=0.8' https://staging.example.com/ | less
```

This command should return this line (amongst others):

```txt
content-type: application/signed-exchange;v=b3
```

[tip type="important"]
The `v=b3` version string is the current version. This version will change. 
[/tip]

The bulk of the response should be your AMP page (in plaintext). There's a small binary header, and, if the page is >16kb, a few binary bytes sprinkled throughout.

You can also test with the more complete accept header sent by Chrome:

```sh
$ curl -si -H 'amp-cache-transform: google' -H 'accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3' https://staging.example.com/ | less
```

The [`dump-signedexchange` tool](https://github.com/WICG/webpackage/blob/master/go/signedexchange/README.md#installation) can be used to inspect the response:

```sh
$ curl -s --output - -H 'amp-cache-transform: google' -H 'accept: application/signed-exchange;v=b3;q=0.9,*/*;q=0.8' https://staging.example.com/ > example.sxg
$ dump-signedexchange -i example.sxg
format version: 1b3
```

(Note that the `-verify` switch will not work at this point because the required certificates are not on the `https://example.com/` server.)

## Deploy packager to production

### Installation

Adjust the staging deployment steps above as appropriate for your production environment.

### Testing

#### With command-line tools

Run through the same tests as above. `dump-signedexchange -verify` should now also succeed.

#### With Chrome

You can also test in Chrome with the help of the [ModHeader extension](https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj?hl=en). Install it from the Chrome Webstore and configure the `Request Headers` to `amp-cache-transform` with a `Value` of `google`.

{{ image('/static/img/docs/guides/sxg/sxg1.jpg', 1900, 666, layout='responsive', alt='Testing Chrome with the help of the ModHeader extension', caption=' ', align='' ) }}

After requesting `https://example.com/` your server will deliver a Signed Exchange, but it should look and behave the same as before. You will need to check that a Signed Exchange is correctly being returned via the[ DevTools console](https://developers.google.com/web/tools/chrome-devtools/).

{{ image('/static/img/docs/guides/sxg/sxg2.jpg', 3058, 1204, layout='responsive', alt='Signed Exchange header displayed in the DevTools console', caption=' ', align='' ) }}

Under the `Network` tab, click on your domain name and check that `Signed HTTP exchange` appears under `Preview`. 

#### With the Google AMP Cache

Confirm that the Signed Exchanges are compatible with the Google AMP cache. This related to their discoverability on search engines such as Google Search. 

To test signed echanges in the Google AMP cache, open the network tab in DevTools, enable `Preserve log`, and visit a URL such as `https://example-com.cdn.ampproject.org/wp/s/example.com/`.

DevTools will show a `200` with a `signed-exchange` row, and a `from signed-exchange` row, if the request was successful. 

If unsuccessful, the signed-exchange rows will be missing, or they will be highlighted red. A `warning` header may also be present that provides additional information.

## Signed Exchanges in Google Search

If your AMP pages were successfully distributed with Signed Exchanges, their search results will display the AMP lightning bolt, same as before, but tapping on the results will show `https://example.com` in the URL bar, instead of a URL beginning with `https://www.google.com/amp/….`. Additionally, the `viewer` bar will not appear.

Within the DevTools console, under the `network` tab, you will be able to see `signed-exchange` under the `type` column.  

{{ image('/static/img/docs/guides/sxg/sxg3.jpg', 1366, 841, layout='responsive', alt='Within the DevTools console, under the network tab, you will be able to see signed-exchange under the type column.', caption=' ', align='' ) }}
